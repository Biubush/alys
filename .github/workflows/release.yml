name: Build and Release

on:
  create:
    tags:
      - 'v*' # 监听以 'v' 开头的标签

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [arm64, amd64, windows-latest]
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8 # 使用 Python 3.8
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller # 安装 pyinstaller
      
    - name: Build binary
      run: |
        pyinstaller -D --add-data "static:static" --add-data "templates:templates" alys.py
        tar -czvf alys-${{ github.ref }}-$PLATFORM.tar.gz dist/ # 使用 tag 和平台信息构建文件名
      env:
        PLATFORM: ${{ matrix.platform }} # 选择平台
      
    - name: Upload release asset
      uses: actions/upload-release-asset@v1
      with:
        asset_path: ./alys-${{ github.ref }}-$PLATFORM.tar.gz # 上传文件
        asset_name: alys-${{ github.ref }}-$PLATFORM.tar.gz
        tag_name: ${{ github.ref }} # 发布标签
